// Top-level build.gradle

plugins {
    id 'com.android.application' version '8.6.0' apply false
    id 'com.android.library' version '8.6.0' apply false
    id 'org.jetbrains.kotlin.android' version '2.1.0' apply false
    id 'com.google.dagger.hilt.android' version '2.54' apply false
    id 'org.jlleitschuh.gradle.ktlint' version '12.1.0' apply false
    id 'io.gitlab.arturbosch.detekt' version '1.23.0' apply false
    id 'org.owasp.dependencycheck' version '8.4.0' apply false
    id 'com.google.devtools.ksp' version '2.1.0-1.0.29' apply false
    id 'org.jetbrains.kotlin.plugin.serialization' version '2.1.0' apply false
    id 'com.google.gms.google-services' version '4.4.2' apply false
    id 'com.google.android.libraries.mapsplatform.secrets-gradle-plugin' version '2.0.1' apply false
}

apply plugin: 'io.gitlab.arturbosch.detekt'
apply plugin: 'org.owasp.dependencycheck'

// 1. ktlint ìƒì„¸ ì„¤ì • (ëª¨ë“  ì„œë¸Œ í”„ë¡œì íŠ¸ ì ìš©)
subprojects {
    apply plugin: 'org.jlleitschuh.gradle.ktlint'

    ktlint {
        version = "1.3.1" // ìµœì‹  ì•ˆì •í™” ë²„ì „ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ
        ignoreFailures = false
        android = true
        verbose = true
        // ì•„ë˜ ì„¤ì •ì„ ì¶”ê°€í•˜ì—¬ ê·œì¹™ ì¶©ëŒì„ ë°©ì§€í•©ë‹ˆë‹¤.
        reporters {
            reporter "plain"
        }
    }
}

// 2. detekt ì„¤ì •
detekt {
    toolVersion = '1.23.3'
    config = files('detekt.yml')
    reports {
        html.enabled = true
        sarif.enabled = true
    }
}

// 3. Git Hook ìë™ ì„¤ì¹˜ íƒœìŠ¤í¬
tasks.register('installGitHooks') {
    group = 'verification'
    description = 'Installs the pre-commit git hooks'

    doLast {
        def hooksDir = new File(rootProject.rootDir, '.git/hooks')
        if (!hooksDir.exists()) hooksDir.mkdirs()

        def preCommitHook = new File(hooksDir, 'pre-commit')

        // í›… ìŠ¤í¬ë¦½íŠ¸: ì»¤ë°‹ ì „ ktlintCheck ì‹¤í–‰
        preCommitHook.text = """#!/bin/bash
echo "ğŸ” [Git Hook] Running ktlint check before commit..."

# ktlintCheck ì‹¤í–‰ (ë¦°íŠ¸ ì—ëŸ¬ê°€ ìˆìœ¼ë©´ exit code 1ì„ ë°˜í™˜í•¨)
./gradlew ktlintCheck

if [ \$? -ne 0 ]; then
    echo ""
    echo "âŒ [Error] ktlint check failed!"
    echo "ì»¤ë°‹í•˜ê¸° ì „ì— ì½”ë“œ ìŠ¤íƒ€ì¼ì„ ìˆ˜ì •í•´ì£¼ì„¸ìš”."
    echo "íŒ: './gradlew ktlintFormat' ëª…ë ¹ì–´ë¡œ ìë™ ìˆ˜ì •ì„ ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
    echo ""
    exit 1
fi

echo "âœ… [Success] ktlint passed! Committing..."
"""
        // ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ (Mac/Linux í•„ìˆ˜)
        preCommitHook.setExecutable(true)
        println "âœ… Git pre-commit hook has been installed to .git/hooks/"
    }
}

// ë¹Œë“œ í™˜ê²½ ì¤€ë¹„ ë‹¨ê³„ì—ì„œ í›… ì„¤ì¹˜ê°€ í•­ìƒ ì‹¤í–‰ë˜ë„ë¡ ì—°ê²°
project.afterEvaluate {
    // Gradle Syncë‚˜ ë¹Œë“œ ì‹œ ìë™ìœ¼ë¡œ í›… ì„¤ì¹˜
    tasks.named('prepareKotlinBuildScriptModel').configure {
        dependsOn installGitHooks
    }
}