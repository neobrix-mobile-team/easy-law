name: ğŸ”¨ EasyLaw Android CI/CD (Gradle 8.6 + Firebase)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    name: ğŸ”¨ Debug APK ë¹Œë“œ (Gradle 8.6)
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ë°›ì•„ì˜¤ê¸°
      uses: actions/checkout@v4
    
    - name: â˜• JDK 17 ì„¤ì •
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
    
    - name: ğŸ”§ Gradle ì„¤ì • (gradle-build-action@v3)
      uses: gradle/gradle-build-action@v3
      with:
        gradle-version: 8.6
    
    - name: ğŸ” Google Services JSON ë””ì½”ë”© (Base64 Secret)
      run: |
        if [ -n "${{ secrets.GOOGLE_SERVICES_JSON }}" ]; then
          echo "${{ secrets.GOOGLE_SERVICES_JSON }}" | base64 --decode > app/google-services.json
          echo "âœ… Firebase Secret ë””ì½”ë”© ì™„ë£Œ"
        else
          echo "âš ï¸ GOOGLE_SERVICES_JSON Secret ì—†ìŒ - Mock ì‚¬ìš©"
        fi
    
    - name: ğŸ”¨ Debug APK ë¹Œë“œ
      run: |
        echo "ğŸ› ï¸ Android Debug APKë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤..."
        gradle assembleDebug --info
        echo "âœ… ë¹Œë“œ ì™„ë£Œ"
    
    - name: ğŸ“¤ ìƒì„±ëœ APK ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: app/build/outputs/apk/debug/
        retention-days: 7

  test:
    name: ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (JUnit)
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ë°›ì•„ì˜¤ê¸°
      uses: actions/checkout@v4
    
    - name: â˜• JDK 17 ì„¤ì •
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
    
    - name: ğŸ”§ Gradle ì„¤ì • (gradle-build-action@v3)
      uses: gradle/gradle-build-action@v3
      with:
        gradle-version: 8.6
    
    - name: ğŸ” Google Services JSON ë””ì½”ë”© (Base64 Secret)
      run: |
        if [ -n "${{ secrets.GOOGLE_SERVICES_JSON }}" ]; then
          echo "${{ secrets.GOOGLE_SERVICES_JSON }}" | base64 --decode > app/google-services.json
        fi
    
    - name: ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (JUnit, Mockito)
      run: |
        echo "ğŸ§¬ ViewModel, Repository ë“± ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."
        gradle testDebugUnitTest --info || true
        echo "âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
    
    - name: ğŸ“¤ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: unit-test-results
        path: |
          app/build/reports/tests/testDebugUnitTest/
          app/build/test-results/testDebugUnitTest/
        retention-days: 7

  ktlint:
    name: ğŸ¨ Kotlin ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬ (ktlint) - MVP ê²½ê³ ë§Œ
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ë°›ì•„ì˜¤ê¸°
      uses: actions/checkout@v4
    
    - name: â˜• JDK 17 ì„¤ì •
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
    
    - name: ğŸ”§ Gradle ì„¤ì • (gradle-build-action@v3)
      uses: gradle/gradle-build-action@v3
      with:
        gradle-version: 8.6
    
    - name: ğŸ” Google Services JSON ë””ì½”ë”© (Base64 Secret)
      run: |
        if [ -n "${{ secrets.GOOGLE_SERVICES_JSON }}" ]; then
          echo "${{ secrets.GOOGLE_SERVICES_JSON }}" | base64 --decode > app/google-services.json
        fi
    
    - name: ğŸ” ktlint ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬ (ê²½ê³ ë§Œ)
      run: |
        echo "ğŸ“ Kotlin ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
        echo "âš ï¸ MVP ë‹¨ê³„: ktlint ê²½ê³ ëŠ” ë¬´ì‹œë©ë‹ˆë‹¤ (ë‚˜ì¤‘ì— ìˆ˜ì •)"
        gradle ktlintMainSourceSetCheck --info || echo "âš ï¸ ktlint ê²½ê³  (ë¬´ì‹œë¨)"
        echo "âœ… ktlint ê²€ì‚¬ ì™„ë£Œ"
    
    - name: ğŸ“¤ ktlint ê²°ê³¼ ì—…ë¡œë“œ
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ktlint-report
        path: |
          build/reports/ktlint/
          app/build/reports/ktlint/
        retention-days: 7

  lint:
    name: ğŸ” Android Lint (í’ˆì§ˆ ê²€ì‚¬)
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ë°›ì•„ì˜¤ê¸°
      uses: actions/checkout@v4
    
    - name: â˜• JDK 17 ì„¤ì •
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
    
    - name: ğŸ”§ Gradle ì„¤ì • (gradle-build-action@v3)
      uses: gradle/gradle-build-action@v3
      with:
        gradle-version: 8.6
    
    - name: ğŸ” Google Services JSON ë””ì½”ë”© (Base64 Secret)
      run: |
        if [ -n "${{ secrets.GOOGLE_SERVICES_JSON }}" ]; then
          echo "${{ secrets.GOOGLE_SERVICES_JSON }}" | base64 --decode > app/google-services.json
        fi
    
    - name: ğŸ” Android Lint í’ˆì§ˆ ê²€ì‚¬
      run: |
        echo "ğŸ” ë³´ì•ˆ, ì„±ëŠ¥, ì ‘ê·¼ì„± ê²€ì‚¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
        gradle lint --info || true
        echo "âœ… Lint ê²€ì‚¬ ì™„ë£Œ"
    
    - name: ğŸ“¤ Lint ê²°ê³¼ ì—…ë¡œë“œ
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: lint-report
        path: |
          app/build/reports/lint-results*.html
          app/build/reports/lint-results*.xml
        retention-days: 7
